const fs = require('fs');
const path = require('path');
const { MongoClient, ObjectId } = require('mongodb');

// Adani Ports OHLC data
const adaniPortsData = `Date,Open,High,Low,Close,Volume
2020-01-01,366.4,368.0,361.55,364.45,1568832
2020-01-02,366.0,369.55,364.0,367.2,2129344
2020-01-03,365.0,373.85,364.25,371.2,2371840
2020-01-06,368.0,374.95,365.25,371.75,2387712
2020-01-07,374.5,380.7,373.6,378.8,3057920
2020-01-08,374.45,377.15,368.9,370.8,2709376
2020-01-09,376.0,381.0,375.2,379.2,3086080
2020-01-10,381.0,385.75,379.4,382.55,2957312
2020-01-13,384.0,386.0,380.85,382.9,2211584
2020-01-14,382.0,387.55,380.55,385.25,2281856
2020-01-15,386.0,387.7,383.5,384.15,1956096
2020-01-16,385.0,386.7,383.25,385.05,1622784
2020-01-17,386.0,387.9,383.0,384.8,2134272
2020-01-20,386.1,386.1,380.5,381.8,1591040
2020-01-21,382.0,382.05,375.25,376.3,2079616
2020-01-22,378.9,380.3,373.0,374.6,2236672
2020-01-23,374.8,377.7,372.65,374.55,1968896
2020-01-24,376.0,376.0,368.25,369.15,2097664
2020-01-27,366.5,373.05,366.05,368.9,2028032
2020-01-28,372.0,375.95,371.75,374.3,2020096
2020-01-29,375.0,382.2,374.8,380.75,3023232
2020-01-30,380.0,382.65,376.4,378.35,2077440
2020-01-31,380.0,381.05,371.8,373.3,2838272
2020-02-01,373.0,375.65,365.05,371.05,3045120
2020-02-03,370.0,370.0,360.15,361.7,2891008
2020-02-04,365.0,369.25,362.2,366.8,2551552
2020-02-05,370.0,376.7,369.0,375.1,2784256
2020-02-06,376.0,380.95,375.25,379.3,3096832
2020-02-07,379.0,388.85,377.15,385.25,4481792
2020-02-10,383.0,383.0,367.0,369.55,4272896
2020-02-11,374.0,375.65,366.5,370.05,2974336
2020-02-12,373.0,376.35,371.0,372.95,2316288
2020-02-13,374.0,375.0,365.25,366.35,3260928
2020-02-14,367.0,368.55,360.4,362.7,2999424
2020-02-17,362.0,362.8,357.0,359.8,1915136
2020-02-18,358.0,359.5,350.1,351.45,4182272
2020-02-19,354.0,361.0,352.25,359.85,4042240
2020-02-20,362.0,369.95,361.1,363.95,7074816
2020-02-24,362.0,362.0,345.6,348.1,5143552
2020-02-25,348.0,348.9,339.05,341.0,7002880
2020-02-26,339.5,345.0,336.25,337.55,5520640
2020-02-27,335.0,336.3,327.25,329.65,9066496
2020-02-28,316.0,323.35,309.0,311.3,12353024
2020-03-02,316.0,330.0,313.05,325.9,8096768
2020-03-03,331.15,338.95,330.0,336.1,8039424
2020-03-04,340.0,342.6,330.1,331.5,6055936
2020-03-05,333.0,333.15,323.05,324.0,6493184
2020-03-06,321.0,321.0,296.25,304.65,16329728
2020-03-09,292.0,292.0,267.4,281.05,13798400
2020-03-11,280.0,293.8,273.55,283.85,13082368
2020-03-12,273.0,273.0,250.1,252.25,13952000
2020-03-13,251.85,285.65,251.85,276.7,20380928
2020-03-16,267.0,267.0,229.7,233.95,12599296
2020-03-17,232.0,243.55,216.1,228.75,17370368
2020-03-18,224.1,228.6,207.1,209.45,14743808
2020-03-19,209.0,220.9,195.75,213.95,18137600
2020-03-20,220.0,226.8,201.2,214.8,18124288
2020-03-23,207.05,207.05,199.05,202.9,9255936
2020-03-24,210.0,219.7,207.45,217.05,11159808
2020-03-25,227.95,238.9,221.7,232.95,16023808
2020-03-26,241.85,266.45,239.55,264.8,26127616
2020-03-27,252.0,260.65,240.5,247.4,16429184
2020-03-30,244.85,244.85,228.05,234.3,12271872
2020-03-31,240.0,248.65,237.0,243.4,12095232
2020-04-01,240.0,240.0,220.65,228.3,11644928
2020-04-03,232.0,232.0,218.0,223.9,9599232
2020-04-07,240.0,257.85,239.0,250.3,19064704
2020-04-08,253.95,254.85,236.15,239.65,16129536
2020-04-09,246.0,256.4,243.0,252.05,13574144
2020-04-13,249.0,249.5,243.0,245.15,6979072
2020-04-15,252.0,252.0,242.25,243.8,9258112
2020-04-16,242.05,250.5,240.2,248.0,11075840
2020-04-17,254.8,264.0,253.05,261.35,17053952
2020-04-20,262.0,267.9,257.7,265.5,10751744
2020-04-21,262.0,262.0,248.5,253.1,11291392
2020-04-22,257.0,263.2,255.15,261.35,9642752
2020-04-23,267.0,270.8,261.3,269.1,13559296
2020-04-24,269.0,276.7,268.0,272.0,18157824
2020-04-27,274.0,282.6,270.6,273.6,14621952
2020-04-28,280.0,288.95,280.0,286.0,12931584
2020-04-29,287.0,291.0,282.0,288.2,9990656
2020-04-30,293.0,302.15,290.1,298.1,15650304
2020-05-04,289.0,289.75,279.55,282.0,8624128
2020-05-05,284.0,288.15,280.75,282.7,8108800
2020-05-06,285.0,288.8,283.35,286.0,6831616
2020-05-07,289.0,289.45,277.8,281.8,8962560
2020-05-08,286.0,291.5,283.0,286.0,10452736
2020-05-11,288.0,293.3,287.35,292.15,7048448
2020-05-12,293.9,294.85,286.0,288.25,7339008
2020-05-13,292.8,294.7,286.5,287.95,7845120
2020-05-14,284.0,286.75,279.15,282.5,9363968
2020-05-15,284.0,288.5,281.05,284.8,7626496
2020-05-18,285.0,292.0,284.35,290.05,6594048
2020-05-19,291.0,294.2,285.65,288.8,7389952
2020-05-20,288.0,294.5,288.0,292.55,7384000
2020-05-21,300.0,300.35,293.65,298.25,11075328
2020-05-22,298.0,298.55,293.1,294.65,7085056
2020-05-26,294.85,314.0,294.85,309.9,17196288
2020-05-27,314.8,319.45,312.05,317.9,15134464
2020-05-28,322.0,331.0,318.0,326.05,18318336
2020-05-29,326.0,348.8,324.05,330.15,34551296
2020-06-01,334.0,340.8,331.5,337.0,9887488
2020-06-02,341.0,352.9,337.3,349.05,16226560
2020-06-03,352.0,356.7,348.3,352.75,16173056
2020-06-04,356.0,361.8,354.15,359.2,17243904
2020-06-05,360.0,364.75,357.5,363.05,12359936
2020-06-08,366.0,370.7,362.25,367.95,11751936
2020-06-09,366.0,371.95,363.5,368.7,10772992
2020-06-10,371.0,374.35,367.6,371.2,9858048
2020-06-11,367.0,369.05,357.55,360.8,9923840
2020-06-12,358.0,359.15,349.75,353.3,8731648
2020-06-15,351.0,356.8,347.5,352.0,10233856
2020-06-16,355.0,359.0,347.0,349.3,12304896
2020-06-17,350.0,352.85,342.8,348.6,11158272
2020-06-18,348.8,357.45,347.25,350.05,11022336
2020-06-19,352.95,358.7,351.3,355.95,12673536
2020-06-22,358.0,358.45,350.1,354.35,10304512
2020-06-23,358.0,359.0,353.0,355.35,13015808
2020-06-24,354.0,354.0,342.0,343.55,14142976
2020-06-25,346.0,350.65,340.35,342.5,13249792
2020-06-26,345.0,346.5,337.5,339.85,10844160
2020-06-29,339.0,341.7,330.05,333.1,11051264
2020-06-30,337.0,342.95,335.0,341.25,8975872
2020-07-01,344.0,349.55,343.1,345.3,11301888
2020-07-02,348.0,353.95,347.0,353.3,9798656
2020-07-03,357.0,365.45,356.65,364.05,11893504
2020-07-06,368.0,381.0,367.75,379.3,13902080
2020-07-07,382.0,385.05,375.05,378.5,14042112
2020-07-08,379.0,383.15,376.0,377.65,10284032
2020-07-09,378.0,384.65,374.05,381.85,10825728
2020-07-10,383.9,385.7,374.25,377.75,11352832
2020-07-13,381.0,383.0,375.05,377.45,8520704
2020-07-14,376.05,376.05,362.85,365.15,12879104
2020-07-15,365.0,369.0,363.0,367.2,8018944`;

// Function to ensure directory exists
function ensureDirectoryExists(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
    console.log(`Created directory: ${dirPath}`);
  }
}

// Main function to upload Adani Ports data
async function uploadAdaniPortsData() {
  try {
    // Ensure public directory exists
    const publicDir = path.join(__dirname, '../public');
    ensureDirectoryExists(publicDir);

    // Ensure ChartsData directory exists
    const chartsDataDir = path.join(publicDir, 'ChartsData');
    ensureDirectoryExists(chartsDataDir);

    // Write CSV data to file
    const filePath = path.join(chartsDataDir, 'ADANIPORTS_2020_2023.csv');
    fs.writeFileSync(filePath, adaniPortsData);
    console.log(`CSV data written to ${filePath}`);

    // Optionally update the database to add csvDataPath to Adani Ports stock
    const updateDatabase = process.argv.includes('--update-db');
    
    if (updateDatabase) {
      const uri = process.env.MONGODB_URI;
      if (!uri) {
        console.error('MONGODB_URI not found in environment variables');
        return;
      }
      
      console.log('Connecting to MongoDB...');
      const client = new MongoClient(uri, { useUnifiedTopology: true });
      await client.connect();
      
      const db = client.db(process.env.MONGODB_DB || 'portfolio_management');
      
      // Update Adani Ports stock in database
      const result = await db.collection('stocks').updateOne(
        { symbol: 'ADANIPORTS' },
        { $set: { csvDataPath: '/ChartsData/ADANIPORTS_2020_2023.csv' } }
      );
      
      if (result.matchedCount === 0) {
        console.log('ADANIPORTS stock not found in the database');
      } else {
        console.log(`Updated ${result.modifiedCount} stock(s) in the database`);
      }
      
      await client.close();
      console.log('Database connection closed');
    }
    
    console.log('Adani Ports data upload completed successfully');
  } catch (error) {
    console.error('Error uploading Adani Ports data:', error);
  }
}

// Execute the function
uploadAdaniPortsData(); 